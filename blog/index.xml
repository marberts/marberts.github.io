<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Steve Martin</title>
<link>https://marberts.github.io/blog/</link>
<atom:link href="https://marberts.github.io/blog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Mon, 24 Nov 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>Making big multilateral indexes fast</title>
  <dc:creator>Steve Martin</dc:creator>
  <link>https://marberts.github.io/blog/posts/2025/multilaterals/</link>
  <description><![CDATA[ 





<p>Multilateral price indexes are often used to measure the evolution of prices over time when there are large volumes of transaction data, such as retail scanner data or housing data. The main challenge with computing multilateral indexes with large amounts of data is that these indexes often depend on a matrix where the dimensions are at least as large as the number of products. Lots of data means lots of different products, which in turns means making quite large matrices. Indeed, assuming these matrices are stored as 64-bit floats (more on that below), <em>at least</em> <img src="https://latex.codecogs.com/png.latex?8n%5E2"> bytes of memory are needed just to store one of these matrices—with, say, 100,000 products, that’s <em>at least</em> 80 GB of memory before doing any computations. Effectively computing these indexes requires a way to reduce the dimensions of these matrices.</p>
<section id="weighted-time-product-dummy" class="level2">
<h2 class="anchored" data-anchor-id="weighted-time-product-dummy">Weighted time product dummy</h2>
<p>Let’s start with the WTPD index. This index is recovered from the coefficient on a set of time-dummy variables in a weighted log-linear regression model with a dummy variable for each product <span class="citation" data-cites="diewert2022">(e.g., Diewert and Fox 2022, eq. 9)</span>. Fitting this model is impractical with many products—with <img src="https://latex.codecogs.com/png.latex?n"> observations for <img src="https://latex.codecogs.com/png.latex?k"> products over <img src="https://latex.codecogs.com/png.latex?t"> time periods, the design matrix is a <img src="https://latex.codecogs.com/png.latex?n%20%5Ctimes%20(k%20+%20t%20-%201)"> matrix and will consume at least <img src="https://latex.codecogs.com/png.latex?8(n%20+%20t%20-%201)%5E2"> bytes of memory. Fortunately, only the coefficients on the time-dummy variables are required to make the index and so the product-dummy variables can be removed by treating them as fixed effects and demeaning the regression equation <span class="citation" data-cites="wooldridge2002">(Wooldridge 2002, sec. 10.5)</span>. Now the design matrix has only <img src="https://latex.codecogs.com/png.latex?t%20-%201"> columns and, as <img src="https://latex.codecogs.com/png.latex?t"> is usually much smaller than <img src="https://latex.codecogs.com/png.latex?k">, will consume far less memory.</p>
<p>Let’s consider a example. We’ll start with a function to make (unbalanced) transaction data for a collection of products over time.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1552443</span>)</span>
<span id="cb1-2"></span>
<span id="cb1-3">make_prices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(products, periods, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frac =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) {</span>
<span id="cb1-4">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb1-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">product =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(products)),</span>
<span id="cb1-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(periods), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> products)),</span>
<span id="cb1-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> periods),</span>
<span id="cb1-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quantity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> periods)</span>
<span id="cb1-9">  )</span>
<span id="cb1-10">  res[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(res), frac <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(res)), ]</span>
<span id="cb1-11">}</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_prices</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>  product time     price  quantity
2       2    1 1.4944618 0.2978414
3       3    1 0.6778284 0.9263743
5       5    1 1.2611687 0.3008513
7       7    1 0.7996127 0.9532272
8       8    1 0.2138277 0.4409094
9       9    1 1.9830544 0.9422246</code></pre>
</div>
</div>
<p>We’ll also make a function to take these data and construct the WTPD index from a fixed-effects model with the <code>{fixest}</code> package.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">wtpd_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(prices) {</span>
<span id="cb3-2">  prices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prices <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-3">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-4">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_weights</span>(price <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> quantity))</span>
<span id="cb3-5"></span>
<span id="cb3-6">  mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fixest<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feols</span>(</span>
<span id="cb3-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> product,</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> prices,</span>
<span id="cb3-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>w</span>
<span id="cb3-10">  )</span>
<span id="cb3-11"></span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(mdl))</span>
<span id="cb3-13">}</span></code></pre></div></div>
</div>
<p>Now let’s build a WTPD index with data for 100,000 products over 25 time periods. Doing this with a regular linear model, where each product has its own dummy variable, would require 1.8 TB of memory to just store the design matrix, making it impractical to calculate. Using a fixed-effects model to recover the WTPD index can be done without issue on any decent laptop.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">price_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_prices</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3">bench<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mark</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fixest =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wtpd_index</span>(price_data))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 fixest        4.08s    4.08s     0.245    2.77GB    0.980</code></pre>
</div>
</div>
<p>Note that this is generally much faster than the routine for making the WTPD index in the excellent <code>{IndexNumR}</code> package.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">wtpd_index2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(prices, window) {</span>
<span id="cb6-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># IndexNumR expects these to be integers.</span></span>
<span id="cb6-3">  prices[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(</span>
<span id="cb6-4">    prices[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>)],</span>
<span id="cb6-5">    as.integer</span>
<span id="cb6-6">  )</span>
<span id="cb6-7">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> IndexNumR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">WTPDIndex</span>(</span>
<span id="cb6-8">    prices,</span>
<span id="cb6-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,</span>
<span id="cb6-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantity"</span>,</span>
<span id="cb6-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>,</span>
<span id="cb6-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>,</span>
<span id="cb6-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">window =</span> window</span>
<span id="cb6-14">  )</span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(res[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb6-16">}</span>
<span id="cb6-17"></span>
<span id="cb6-18">price_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_prices</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb6-19"></span>
<span id="cb6-20">bench<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mark</span>(</span>
<span id="cb6-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fixest =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wtpd_index</span>(price_data)),</span>
<span id="cb6-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">IndexNumR =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wtpd_index2</span>(price_data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb6-23">)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 fixest       10.6ms  13.05ms    74.3      1.51MB     1.96
2 IndexNumR     4.25s    4.25s     0.235  102.15MB     7.05</code></pre>
</div>
</div>
</section>
<section id="geary-khamis-index" class="level2">
<h2 class="anchored" data-anchor-id="geary-khamis-index">Geary-Khamis index</h2>
<p>The GK index is another multilateral index that’s often written as a function of a large matrix. Following <span class="citation" data-cites="diewert2022">Diewert and Fox (2022)</span>, the GK index can be written as a function of two <img src="https://latex.codecogs.com/png.latex?k%20%5Ctimes%20k"> matrices. One of these matrices is diagonal, so it can be handled efficiently, but the other is usually dense (unless product imbalanced is really bad) and is impractical to store in memory. Using the same data as with the WTPD index, it would require 80 GB of memory to just store this matrix.</p>
<p>An alternative approach <span class="citation" data-cites="balk2008">(Balk 2008, 245–46)</span> expresses the GK index as a function of three <img src="https://latex.codecogs.com/png.latex?t%20%5Ctimes%20t"> matrices. With the same data as before, this now requires only 15 KB of memory. Here is relatively fast function to implement this approach.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Intertemporal Geary-Khamis index</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Make a multilateral Geary-Khamis price index.</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param p A numeric vector of prices.</span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param q A numeric vector of quantities.</span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param period A factor, or something that can be coerced into one, that</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'   gives the corresponding time period for each element in `p` and</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'   `q`. The ordering of time periods follows the levels of `period`</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'   to agree with [`cut()`][cut.Date].</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param product A factor, or something that can be coerced into one, that</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'   gives the corresponding product identifier for each element in `p` and</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'   `q`.</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param na.rm Should missing values be removed? By default they are not.</span></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @returns</span></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' A numeric vector of period-over-period price indexes.</span></span>
<span id="cb8-18"></span>
<span id="cb8-19">fast_gk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(p, q, period, product, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) {</span>
<span id="cb8-20">  period <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(period)</span>
<span id="cb8-21">  product <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(product)</span>
<span id="cb8-22"></span>
<span id="cb8-23">  qs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(q, product), gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>scale_weights), product)</span>
<span id="cb8-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span>(product) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># faster to match on numeric codes</span></span>
<span id="cb8-25">  ux <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(product)</span>
<span id="cb8-26">  product <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(</span>
<span id="cb8-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(product, period),</span>
<span id="cb8-28">    \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(ux, x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">incomparables =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb8-29">  )</span>
<span id="cb8-30"></span>
<span id="cb8-31">  v <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Map</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q, period), product)</span>
<span id="cb8-32">  qs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Map</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(qs, period), product)</span>
<span id="cb8-33"></span>
<span id="cb8-34">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(period)</span>
<span id="cb8-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the matrices from pp. 245-246 of Balk (2008) to build the quantity</span></span>
<span id="cb8-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># index, then deflate.</span></span>
<span id="cb8-37">  m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, n)</span>
<span id="cb8-38">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(m)) {</span>
<span id="cb8-39">    m[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vapply</span>(</span>
<span id="cb8-40">      qs,</span>
<span id="cb8-41">      \(qs) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(qs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_weights</span>(v[[i]]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> na.rm),</span>
<span id="cb8-42">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L)</span>
<span id="cb8-43">    )</span>
<span id="cb8-44">  }</span>
<span id="cb8-45">  e <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(n)</span>
<span id="cb8-46">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n, n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb8-47">  q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(rbind, m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> e <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L, ]</span>
<span id="cb8-48">  v <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vapply</span>(v, sum, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> na.rm)</span>
<span id="cb8-49">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the period-over-period index.</span></span>
<span id="cb8-50">  v[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> v[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(v)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (q[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> q[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(q)])</span>
<span id="cb8-51">}</span></code></pre></div></div>
</div>
<p>As with the WTPD index, any decent laptop can compute this index.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">gk_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(prices) {</span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fast_gk</span>(</span>
<span id="cb9-3">    prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price,</span>
<span id="cb9-4">    prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>quantity,</span>
<span id="cb9-5">    prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb9-6">    prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>product,</span>
<span id="cb9-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb9-8">  )</span>
<span id="cb9-9">}</span>
<span id="cb9-10"></span>
<span id="cb9-11">price_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_prices</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb9-12"></span>
<span id="cb9-13">bench<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mark</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fast_gk =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gk_index</span>(price_data))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 fast_gk       1.32s    1.32s     0.755     819MB     2.26</code></pre>
</div>
</div>
<p>It is similarly non-trivial to make an index of this size with <code>{IndexNumR}</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">gk_index2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(prices, window) {</span>
<span id="cb11-2">  prices[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(</span>
<span id="cb11-3">    prices[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>)],</span>
<span id="cb11-4">    as.integer</span>
<span id="cb11-5">  )</span>
<span id="cb11-6">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> IndexNumR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GKIndex</span>(</span>
<span id="cb11-7">    prices,</span>
<span id="cb11-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>,</span>
<span id="cb11-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantity"</span>,</span>
<span id="cb11-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>,</span>
<span id="cb11-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"product"</span>,</span>
<span id="cb11-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">window =</span> window</span>
<span id="cb11-13">  )</span>
<span id="cb11-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(res[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> res[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(res)])</span>
<span id="cb11-15">}</span>
<span id="cb11-16"></span>
<span id="cb11-17">price_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_prices</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb11-18"></span>
<span id="cb11-19">bench<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mark</span>(</span>
<span id="cb11-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fast_gk =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gk_index</span>(price_data)),</span>
<span id="cb11-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">IndexNumR =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gk_index2</span>(price_data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb11-22">)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 fast_gk      8.03ms   8.56ms   109.       8.15MB    5.93 
2 IndexNumR      1.7s     1.7s     0.587  332.21MB    0.587</code></pre>
</div>
</div>
</section>
<section id="repeat-sales" class="level2">
<h2 class="anchored" data-anchor-id="repeat-sales">Repeat sales</h2>
<p>The repeat-sales indexes listed by <span class="citation" data-cites="shiller1991">Shiller (1991)</span> are a type of multilateral index usually found in the housing economics literature. Like the WTPD index, they come from linear models and suffer from the same large design matrices. The geometric repeat-sales index is like the WTPD index, although usually with a much longer time horizon, except that it uses the first-difference transformation to sweep out the product fixed effects instead of the within-group transformation. The arithmetic repeat-sales index is more complicated as it comes from an IV estimator and its not obvious, at least to me, how the matrices for this index can be made smaller.</p>
<p>Instead of reducing the dimensionality of the repeat-sales matrices, these matrices are naturally sparse when products sell infrequently (like housing) and can be stored as sparse matrices. Let’s adapt the vignette from my <code>{rsmatrix}</code> package to see this in action with some data for 5 million house sales over 30 years.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">periods <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2000-01-01"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2029-12-31"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day"</span>)</span>
<span id="cb13-2"></span>
<span id="cb13-3">prices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb13-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sale =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(periods, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e6</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb13-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">property =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%06d"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e6</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))),</span>
<span id="cb13-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e6</span>)</span>
<span id="cb13-7">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">period =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(sale, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"month"</span>))</span>
<span id="cb13-9"></span>
<span id="cb13-10">sales_pairs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsmatrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rs_pairs</span>(prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sale, prices<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>property)</span>
<span id="cb13-11">prices[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price_prev"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"period_prev"</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prices[</span>
<span id="cb13-12">  sales_pairs,</span>
<span id="cb13-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"period"</span>)</span>
<span id="cb13-14">]</span>
<span id="cb13-15"></span>
<span id="cb13-16">prices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prices <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-17">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb13-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">holding_period =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(period) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(period_prev)</span>
<span id="cb13-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-20">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(holding_period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb13-21"></span>
<span id="cb13-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(prices)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>        sale property     price     period price_prev period_prev
1 2016-05-11   627686 0.7705151 2016-05-01  0.1878927  2014-06-01
2 2029-07-22   992771 0.2366689 2029-07-01  0.4822262  2026-10-01
3 2011-07-17   925847 0.1712451 2011-07-01  0.5992709  2003-05-01
4 2013-03-28   337973 0.1540939 2013-03-01  0.9106525  2002-11-01
5 2008-04-22   295262 0.3274417 2008-04-01  0.2760829  2003-10-01
6 2015-12-27   038822 2.2174534 2015-12-01  1.7673652  2010-11-01
  holding_period
1             23
2             33
3             98
4            124
5             54
6             61</code></pre>
</div>
</div>
<p>We can now build a generator to make the sparse repeat-sales matrices. If these were dense matrices they would consume 22.1 GB of memory. This isn’t nearly as bad as the WTPD or GK indexes, but still enough to make computing these indexes cumbersome. With sparse matrices, however, it is easy to make the repeat-sales index.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">matrices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(</span>
<span id="cb15-2">  prices,</span>
<span id="cb15-3">  rsmatrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rs_matrix</span>(period, period_prev, price, price_prev, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb15-4">)</span>
<span id="cb15-5"></span>
<span id="cb15-6">Z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrices</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Z"</span>)</span>
<span id="cb15-7">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrices</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>)</span>
<span id="cb15-8">Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrices</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>)</span>
<span id="cb15-9"></span>
<span id="cb15-10">bench<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mark</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossprod</span>(Z, X), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossprod</span>(Z, Y)))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 ars           1.59s    1.59s     0.627       3MB        0</code></pre>
</div>
</div>
</section>
<section id="geks" class="level2">
<h2 class="anchored" data-anchor-id="geks">GEKS</h2>
<p>Let’s conclude by briefly mentioned the GEKS family of multilateral indexes. As with the others, the GEKS depends on a matrix, but it is only a <img src="https://latex.codecogs.com/png.latex?t%20%5Ctimes%20t"> matrix and will require very little memory. This makes GEKS indexes somewhat more straightforward to compute than the other popular multilateral indexes.</p>
<details>
<summary>
Session Info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.12.0 
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.12.0  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: America/Toronto
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] Matrix_1.7-4        jsonlite_2.0.0      dplyr_1.1.4        
 [4] compiler_4.5.2      rsmatrix_0.2.9      tidyselect_1.2.1   
 [7] Rcpp_1.1.0          yaml_2.3.10         fastmap_1.2.0      
[10] lattice_0.22-7      R6_2.6.1            generics_0.1.4     
[13] Formula_1.2-5       knitr_1.50          htmlwidgets_1.6.4  
[16] tibble_3.3.0        pillar_1.11.1       rlang_1.1.6        
[19] utf8_1.2.6          xfun_0.54           stringmagic_1.2.0  
[22] fixest_0.13.2       cli_3.6.5           magrittr_2.0.4     
[25] digest_0.6.38       grid_4.5.2          IndexNumR_0.6.0    
[28] sandwich_3.1-1      gpindex_0.6.3       lifecycle_1.0.4    
[31] nlme_3.1-168        vctrs_0.6.5         bench_1.1.4        
[34] evaluate_1.0.5      glue_1.8.0          data.table_1.17.8  
[37] numDeriv_2016.8-1.1 zoo_1.8-14          profmem_0.7.0      
[40] dreamerr_1.5.0      rmarkdown_2.30      tools_4.5.2        
[43] pkgconfig_2.0.3     htmltools_0.5.8.1  </code></pre>
</div>
</div>
</details>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-balk2008" class="csl-entry">
Balk, Bert M. 2008. <em>Price and Quantity Index Numbers: Models for Measuring Aggregate Change and Difference</em>. Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511720758">https://doi.org/10.1017/CBO9780511720758</a>.
</div>
<div id="ref-diewert2022" class="csl-entry">
Diewert, W Erwin, and Kevin J Fox. 2022. <span>“Substitution Bias in Multilateral Methods for Cpi Construction.”</span> <em>Journal of Business &amp; Economic Statistics</em> 40 (1): 355–69. <a href="https://doi.org/10.1080/07350015.2020.1816176">https://doi.org/10.1080/07350015.2020.1816176</a>.
</div>
<div id="ref-shiller1991" class="csl-entry">
Shiller, Robert J. 1991. <span>“Arithmetic Repeat Sales Price Estimators.”</span> <em>Journal of Housing Economics</em> 1 (1): 110–26. <a href="https://doi.org/10.1016/S1051-1377(05)80028-2">https://doi.org/10.1016/S1051-1377(05)80028-2</a>.
</div>
<div id="ref-wooldridge2002" class="csl-entry">
Wooldridge, Jeffrey M. 2002. <em>Econometric Analysis of Cross Section and Panel Data</em>. MIT Press.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{martin2025,
  author = {Martin, Steve},
  title = {Making Big Multilateral Indexes Fast},
  date = {2025-11-24},
  url = {https://marberts.github.io/blog/posts/2025/multilaterals/},
  doi = {10.59350/c2v2f-rnj27},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-martin2025" class="csl-entry quarto-appendix-citeas">
Martin, Steve. 2025. <span>“Making Big Multilateral Indexes
Fast.”</span> November 24, 2025. <a href="https://doi.org/10.59350/c2v2f-rnj27">https://doi.org/10.59350/c2v2f-rnj27</a>.
</div></div></section></div> ]]></description>
  <category>Performance</category>
  <category>Index numbers</category>
  <category>R</category>
  <guid>https://marberts.github.io/blog/posts/2025/multilaterals/</guid>
  <pubDate>Mon, 24 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>How does the difference between the arithmetic and geometric mean depend on variance?</title>
  <dc:creator>Steve Martin</dc:creator>
  <link>https://marberts.github.io/blog/posts/2025/variance-inequality/</link>
  <description><![CDATA[ 





<p>That the arithmetic mean of a set of number is larger than the geometric mean is a foundational result in the theory of inequalities. This is a useful result for index numbers in particular as it gives that, for the same data, an index based on an arithmetic mean will always be larger than the corresponding index based on the geometric mean.</p>
<p>The latest edition of the CPI manual says the following about the difference between the arithmetic and geometric mean and how it relates to variance <span class="citation" data-cites="cpi2020">(IMF et al. 2020, 2)</span></p>
<blockquote class="blockquote">
<p>It should be noted that an arithmetic average is always greater than or equal to a geometric average and that the difference will be greater, the greater the variance in the price relatives.</p>
</blockquote>
<p>This seems like a great result that gives a way to easily think about the relationship between an index that uses an arithmetic mean to aggregate price relatives (Carli index) and one that uses a geometric mean (Jevons index). <sup>1</sup> Unfortunately it’s not true—see <span class="citation" data-cites="lord2002">Lord (2002)</span> for a neat way to generate counter examples. <sup>2</sup></p>
<p>The issue is that, for a vector of positive numbers <img src="https://latex.codecogs.com/png.latex?x%5Cin%5Cmathbf%7BR%7D_%7Bn%7D%5E%7B++%7D">, the difference between the arithmetic mean <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BA%7D(x)"> and geometric mean <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BG%7D(x)"> is only <em>bounded</em> by the variance <span class="citation" data-cites="bullen2003">(Bullen 2003, 156)</span></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Ctext%7Bvar%7D(x)%7D%7B2%20%5Cmax(x)%7D%20%5Cleq%20%5Cmathfrak%7BA%7D(x)%20-%20%5Cmathfrak%7BG%7D(x)%20%5Cleq%20%5Cfrac%7B%5Ctext%7Bvar%7D(x)%7D%7B2%20%5Cmin(x)%7D.%0A"></p>
<p>For two vectors <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?y">, we have that <img src="https://latex.codecogs.com/png.latex?%5Cmathfrak%7BA%7D(y)%20-%20%5Cmathfrak%7BG%7D(y)%20%3E%20%5Cmathfrak%7BA%7D(x)%20-%20%5Cmathfrak%7BG%7D(x)"> if</p>
<p><span id="eq-ineq1"><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bvar%7D(y)%20%3E%20%5Cfrac%7B%5Cmax(y)%7D%7B%5Cmin(x)%7D%5Ctext%7Bvar%7D(x)%0A%5Ctag%7B1%7D"></span></p>
<p>and the opposite if</p>
<p><span id="eq-ineq2"><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bvar%7D(y)%20%3C%20%5Cfrac%7B%5Cmin(y)%7D%7B%5Cmax(x)%7D%5Ctext%7Bvar%7D(x)%0A%5Ctag%7B2%7D"></span></p>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Cmax(y)%20%3E%20%5Cmin(x)"> (what we should expect) then the difference between the arithmetic and geometric mean increases with a sufficiently large increase in variance. Similarly, if <img src="https://latex.codecogs.com/png.latex?%5Cmin(y)%20%3C%20%5Cmax(x)"> then the difference between the arithmetic and geometric mean decreases with a sufficiently large decrease in variance. If the support of the distribution is sufficiently narrow then the difference between the arithmetic and geometric mean will follow closely with the variance, and this is similar to the argument that generates the claim in the CPI manual <span class="citation" data-cites="cpitheory">(IMF et al. 2025, 131)</span>.</p>
<p>What I want to understand is how the difference between the arithmetic and geometric mean changes for <em>smaller</em> changes in variance without placing restrictions on the support of the distribution. Let’s consider drawing a collection of samples from a fixed probability distribution to see how the difference between the arithmetic and geometric mean relates to variance among samples from that distribution. We’ll make a few helper functions for this.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">var_ineq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb1-2">  m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x)</span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb1-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> m)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb1-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diff =</span> m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(x))),</span>
<span id="cb1-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x),</span>
<span id="cb1-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(x)</span>
<span id="cb1-8">  )</span>
<span id="cb1-9">}</span>
<span id="cb1-10"></span>
<span id="cb1-11">simulate_var_ineq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(n, sim, dist) {</span>
<span id="cb1-12">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dist</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sim), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> n), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, var_ineq)</span>
<span id="cb1-13">  res[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(res[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, ])]</span>
<span id="cb1-14">}</span>
<span id="cb1-15"></span>
<span id="cb1-16">prob_decrease <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb1-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb1-18">    x,</span>
<span id="cb1-19">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb1-20">    \(z) {</span>
<span id="cb1-21">      cond <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb1-22">        x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>]</span>
<span id="cb1-23">      x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[, cond]</span>
<span id="cb1-24">      decrease <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diff"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diff"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>]</span>
<span id="cb1-25">      increase <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diff"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diff"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> z[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>]</span>
<span id="cb1-26"></span>
<span id="cb1-27">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(decrease <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> increase) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-28">    }</span>
<span id="cb1-29">  )</span>
<span id="cb1-30">}</span></code></pre></div></div>
</div>
<p>The scatter plot of the difference between the arithmetic and geometric mean and variance for a sample of size 10 shows that, although the difference tends to increase with variance, there are several instances where the opposite occurs.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15243</span>)</span>
<span id="cb2-2"></span>
<span id="cb2-3">sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_var_ineq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, \(n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>))</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sim), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arithmetic mean - geometric mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variance"</span>)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">symbols</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.13</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">circles =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.015</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inches =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">symbols</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.065</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">circles =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inches =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/variance-inequality/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To better understand this, let’s simulate the probability that the difference between the arithmetic and geometric mean decreases with variance, conditional on Equation&nbsp;1 and Equation&nbsp;2 not holding.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_var_ineq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, \(n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_decrease</span>()</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(res)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.000   4.400   6.340   6.562   8.020  35.160 </code></pre>
</div>
</div>
<p>Overall, the median of the conditional probability that the difference between the arithmetic and geometric mean decreases with variance is about 6.3%. This is a fairly small probability for the difference between the means to decrease when variance increases, although it depends on the underlying population from which samples are drawn. Drawing samples from a distribution with a wider support makes it more likely to see the difference between the arithmetic and geometric mean decreases with variance.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_var_ineq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, \(n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_decrease</span>()</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(res)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.020   8.515  13.400  13.579  17.100  50.580 </code></pre>
</div>
</div>
<p>As the support of the distribution shrinks, the difference between the arithmetic and geometric mean follows the variance more closely and the probabiltity that the difference in means decreases as variance increases becomes small.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_var_ineq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, \(n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_decrease</span>()</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(res)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.000   0.800   1.140   1.194   1.500   4.560 </code></pre>
</div>
</div>





<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-bullen2003" class="csl-entry">
Bullen, P. S. 2003. <em>Handbook of Means and Their Inequalities</em>. Springer Science+Business Media. <a href="https://doi.org/10.1007/978-94-017-0399-4">https://doi.org/10.1007/978-94-017-0399-4</a>.
</div>
<div id="ref-cpi2020" class="csl-entry">
IMF, ILO, Eurostat, UNECE, OECD, and World Bank. 2020. <em>Consumer Price Index Manual: Concepts and Methods</em>. International Monetary Fund. <a href="https://doi.org/10.5089/9781484354841.069 ">https://doi.org/10.5089/9781484354841.069 </a>.
</div>
<div id="ref-cpitheory" class="csl-entry">
———. 2025. <em>Consumer Price Index Manual: Theory</em>. International Monetary Fund. <a href="https://doi.org/10.5089/9781513559605.069">https://doi.org/10.5089/9781513559605.069</a>.
</div>
<div id="ref-lord2002" class="csl-entry">
Lord, N. 2002. <span>“Does Smaller Spread Always Mean Larger Product?”</span> <em>The Mathematical Gazette</em>, no. 506, 86: 273–74. <a href="https://doi.org/10.2307/3621857">https://doi.org/10.2307/3621857</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The CPI manual is more precise on page 179 and notes that the difference between the arithmetic and geometric mean <em>tends</em> to increase with variance.↩︎</p></li>
<li id="fn2"><p>This can also apply to the difference between the arithmetic mean and harmonic mean, where it is often suggested that the difference between these means increases with variance <span class="citation" data-cites="cpitheory">(IMF et al. 2025, 131)</span>.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{martin2025,
  author = {Martin, Steve},
  title = {How Does the Difference Between the Arithmetic and Geometric
    Mean Depend on Variance?},
  date = {2025-11-12},
  url = {https://marberts.github.io/blog/posts/2025/variance-inequality/},
  doi = {10.59350/rpvm0-57912},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-martin2025" class="csl-entry quarto-appendix-citeas">
Martin, Steve. 2025. <span>“How Does the Difference Between the
Arithmetic and Geometric Mean Depend on Variance?”</span> November 12,
2025. <a href="https://doi.org/10.59350/rpvm0-57912">https://doi.org/10.59350/rpvm0-57912</a>.
</div></div></section></div> ]]></description>
  <category>Inequalities</category>
  <category>Index numbers</category>
  <category>R</category>
  <guid>https://marberts.github.io/blog/posts/2025/variance-inequality/</guid>
  <pubDate>Wed, 12 Nov 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Hedonic imputation with one regression, not two</title>
  <dc:creator>Steve Martin</dc:creator>
  <link>https://marberts.github.io/blog/posts/2025/hedonics/</link>
  <description><![CDATA[ 





<p>Comparing housing prices over time is difficult because of all the heterogeneity in housing that can both affect prices and vary over time. The typical solution to this problem is to use a hedonic price index that attempts to model the relationship between housing characteristics and price, and uses this to control the change in these characteristics over time.</p>
<p>Although there are several approaches to building a hedonic price index, the double imputation approach is usually seen as the best. Every presentation of this method that I have seen calculates the index by fitting two regression models and combining the fitted values from these models in a geometric index <span class="citation" data-cites="aizcorbe2014 rppi2013 rppi2020">(e.g., Aizcorbe 2014; ILO et al. 2013; IMF 2020)</span>. What I want to show here is that the double imputation index can be recovered from the coefficient in a linear regression. This makes it simpler to calculate the index and provides an easy strategy to estimate conventional standard errors.</p>
<section id="turning-two-regressions-into-one" class="level2">
<h2 class="anchored" data-anchor-id="turning-two-regressions-into-one">Turning two regressions into one</h2>
<p>The hedonic imputation model starts with two linear models, one for transactions in period 0,</p>
<p><span id="eq-laspeyres"><img src="https://latex.codecogs.com/png.latex?%0A%5Clog(p_%7Bi0%7D)%20=%20%5Calpha_%7B0%7D%20+%20x_%7Bi0%7D%20%5Cbeta_%7B0%7D%20+%20u_%7Bi0%7D,%0A%5Ctag%7B1%7D"></span></p>
<p>and one for transactions in period 1,</p>
<p><span id="eq-paasche"><img src="https://latex.codecogs.com/png.latex?%0A%5Clog(p_%7Bi1%7D)%20=%20%5Calpha_%7B1%7D%20+%20x_%7Bi1%7D%20%5Cbeta_%7B1%7D%20+%20e_%7Bi1%7D,%0A%5Ctag%7B2%7D"></span></p>
<p>where <img src="https://latex.codecogs.com/png.latex?x_%7Bit%7D"> is a vector of characteristics that confound a change in price over time with a change in the composition of housing.</p>
<p>The Laspeyres hedonic imputation index, <img src="https://latex.codecogs.com/png.latex?I">, compares the predicted prices from Equation&nbsp;2 against those from Equation&nbsp;1 over the distribution of characteristics in period 0</p>
<p><span id="eq-lhi"><img src="https://latex.codecogs.com/png.latex?%0A%5Clog(I)%20=%20%5Calpha_%7B1%7D%20-%20%5Calpha_%7B0%7D%20+%20%5Cbar%7Bx%7D_%7B0%7D%20(%5Cbeta_%7B1%7D%20-%20%5Cbeta_%7B0%7D),%0A%5Ctag%7B3%7D"></span></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B0%7D"> is the vector of average period 0 characteristics. This is equation 5.19 in <span class="citation" data-cites="rppi2013">ILO et al. (2013)</span>.</p>
<p>Equation&nbsp;1 and Equation&nbsp;2 can be nested to get a single linear model. Subtracting <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B0%7D"> from the interaction term then gives Equation&nbsp;3 as a coefficient on a time dummy variable</p>
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Clog(p_%7Bit%7D)%20&amp;=%20%5Calpha_%7B0%7D%20+%20x_%7Bit%7D%20%5Cbeta_%7B0%7D%20+%20t%20(%5Calpha_%7B1%7D%20-%20%5Calpha_%7B0%7D%20+%20x_%7Bit%7D%20(%5Cbeta_%7B1%7D%20-%20%5Cbeta_%7B0%7D))%20+%20u_%7Bit%7D%20+%20t(e_%7Bit%7D%20-%20u_%7Bit%7D)%5C%5C%0A%0A&amp;=%20%5Calpha_%7B0%7D%20+%20t%20%5Clog(I)%20+%20x_%7Bit%7D%20%5Cbeta_%7B0%7D%20+%20t%20(x_%7Bit%7D%20-%20%5Cbar%7Bx%7D_%7B0%7D)%20(%5Cbeta_%7B1%7D%20-%20%5Cbeta_%7B0%7D)%20+%20%5Cvarepsilon_%7Bit%7D,%0A%5Cend%7Balign%7D">
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cvarepsilon_%7Bit%7D%20=%20u_%7Bit%7D%20+%20t(e_%7Bit%7D%20-%20u_%7Bit%7D)">. The Paasche hedonic imputation index follows along the same lines, replacing <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B0%7D"> with <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B1%7D">. The Fisher hedonic imputation index combines these two, which is the same as replacing <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B0%7D"> with <img src="https://latex.codecogs.com/png.latex?%5Cbar%7Bx%7D_%7B0%7D%20/%202%20+%20%5Cbar%7Bx%7D_%7B1%7D%20/%202">. Note that this reduces to the classic time-dummy hedonic index when <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B1%7D%20=%20%5Cbeta_%7B0%7D">.<sup>1</sup></p>
</section>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">An example</h2>
<p>Let’s go through an example to see this in action. As the goal is just to give an example, I’ll make up some typical-looking transaction data for property sales with a few characteristics over two periods.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15243</span>)</span>
<span id="cb1-2"></span>
<span id="cb1-3">sales <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb1-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">period =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>)),</span>
<span id="cb1-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">price =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>),</span>
<span id="cb1-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">area =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span>),</span>
<span id="cb1-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb1-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">amenity_score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb1-9">)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(sales)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>  period     price      area age amenity_score
1      0 1.8931980 2415.7592  70    0.01447159
2      0 0.9737266 2244.8349   5    0.59602963
3      0 0.9860096 1937.4438  80    0.39965375
4      0 1.4830738  989.7379  66    0.16038727
5      0 0.3651522 2324.3656  50    0.82509594
6      0 0.7955844 1930.3795  12    0.38836734</code></pre>
</div>
</div>
<p>We’ll work with the following basic model relating price with characteristics in each period</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Clog(%5Ctext%7Bprice%7D_%7Bit%7D)%20=%20%5Calpha_%7Bt%7D%20+%20%5Cbeta_%7B1t%7D%5Ctext%7Bage%7D_%7Bit%7D%20+%20%5Cbeta_%7B2t%7D%5Ctext%7Barea%7D_%7Bit%7D%20+%20%5Cbeta_%7Bi3%7D%5Ctext%7Barea%7D_%7Bit%7D%5E2%20+%20%5Cbeta_%7Bi4%7D%5Ctext%7Bneighbourhoodscore%7D_%7Bit%7D%20+%20%5Cvarepsilon_%7Bit%7D.%0A"></p>
<p>The two-regression approach for making the Laspeyres-imputation index fits two separate models for each time period and compares the average ratio of prediceted prices over the distribution of housing characteristics for sales in period 0.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sales2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(sales, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>period)</span>
<span id="cb3-2"></span>
<span id="cb3-3">mdl1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(area<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> amenity_score, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb3-4"></span>
<span id="cb3-5">mdl2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(area<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> amenity_score, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb3-6"></span>
<span id="cb3-7">laspeyres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl2, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl1, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])))</span>
<span id="cb3-8"></span>
<span id="cb3-9">laspeyres</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9367763</code></pre>
</div>
</div>
<p>The Paasche-imputation index does the same thing, just over the distribution of characteristics for sales in period 1, and the Fisher-imputation index combines the Laspeyres and Paasche indexes.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">paasche <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl2, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl1, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])))</span>
<span id="cb5-2"></span>
<span id="cb5-3">paasche</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9376688</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">fisher <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(laspeyres <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> paasche)</span>
<span id="cb7-2"></span>
<span id="cb7-3">fisher</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9372224</code></pre>
</div>
</div>
<p>To make these indexes with one regression we need to remove the appropriate mean from the characteristics variables and interact them with the time dummy in the linear model. In each case the coefficient on the time dummy variable gives the same index as using two regressions. For simplicitly, I’ll just show the case of the Fisher index.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">dm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb9-2">  m0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">substitute</span>(period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent.frame</span>())])</span>
<span id="cb9-3">  m1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">substitute</span>(period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent.frame</span>())])</span>
<span id="cb9-4">  x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(m0, m1))</span>
<span id="cb9-5">}</span>
<span id="cb9-6"></span>
<span id="cb9-7">mdl_fisher <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(</span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(price) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">    age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">    area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(area<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-12">    amenity_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-13">    period<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(area) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(area<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(amenity_score)),</span>
<span id="cb9-14">  sales</span>
<span id="cb9-15">)</span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.equal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(mdl_fisher)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"period"</span>]), fisher, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">check.attributes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Representing the Fisher index as the coefficient in a linear model also makes it easy to get the (delta method) standard error for the index. <sup>2</sup></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(mdl_fisher)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"period"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(sandwich<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vcovHC</span>(mdl_fisher)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>   period 
0.1009944 </code></pre>
</div>
</div>
</section>
<section id="why-two-regressions-can-be-better" class="level2">
<h2 class="anchored" data-anchor-id="why-two-regressions-can-be-better">Why two regressions can be better</h2>
<p>As noted by <span class="citation" data-cites="aizcorbe2014">Aizcorbe (2014, chap. 3)</span>, constructing the hedonic-imputation index with two regressions is more flexible than recovering an index from a regression coefficient. The trick of doing it with one regression works because the model is linear; using a non-linear regression model (however rare) may require fitting two models separately. Explicitly using the fitted values from two models to make price relatives also allows for the use of other index-number formulas, not just geometric ones.</p>
<p>One reason that I’ve not seen for the two-regression approach is that it’s also more convenient to calculate product contributions when doing two regressions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">laspeyres_relatives <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(</span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl2, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl1, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb13-3">)</span>
<span id="cb13-4">contrib_laspeyres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geometric_contributions</span>(laspeyres_relatives)</span>
<span id="cb13-5"></span>
<span id="cb13-6">paasche_relatives <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(</span>
<span id="cb13-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl2, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl1, sales2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb13-8">)</span>
<span id="cb13-9">contrib_paasche <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geometric_contributions</span>(paasche_relatives)</span>
<span id="cb13-10"></span>
<span id="cb13-11">contrib_fisher <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Map</span>(</span>
<span id="cb13-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">*</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>,</span>
<span id="cb13-13">  gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute_weights</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(laspeyres, paasche)),</span>
<span id="cb13-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(contrib_laspeyres, contrib_paasche)</span>
<span id="cb13-15">)</span>
<span id="cb13-16"></span>
<span id="cb13-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(</span>
<span id="cb13-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(contrib_fisher)),</span>
<span id="cb13-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of sales contributions"</span></span>
<span id="cb13-20">)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/hedonics/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-aizcorbe2014" class="csl-entry">
Aizcorbe, Ana M. 2014. <em>A Practical Guide to Price Index and Hedonic Techniques</em>. Oxford University Press. <a href="https://doi.org/10.1093/acprof:oso/9780198702429.001.0001">https://doi.org/10.1093/acprof:oso/9780198702429.001.0001</a>.
</div>
<div id="ref-rppi2013" class="csl-entry">
ILO, IMF, OECD, UNECE, and World Bank. 2013. <em>Handbook on Residential Property Prices Indices (RPPIs)</em>. Eurostat. <a href="https://doi.org/10.2785/34007">https://doi.org/10.2785/34007</a>.
</div>
<div id="ref-rppi2020" class="csl-entry">
IMF. 2020. <em>Residential Property Prices Index (RPPI) Practical Compilation Guide</em>. International Monetary Fund. <a href="https://www.imf.org/en/Data/Statistics/RPPI-guide">https://www.imf.org/en/Data/Statistics/RPPI-guide</a>.
</div>
<div id="ref-wooldridge2002" class="csl-entry">
Wooldridge, Jeffrey M. 2002. <em>Econometric Analysis of Cross Section and Panel Data</em>. MIT Press.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This type of regression model comes up in the literature on program evaluation as a way to estimate average treatment effects; see, e.g., <span class="citation" data-cites="wooldridge2002">Wooldridge (2002, sec. 18.3.1)</span>.↩︎</p></li>
<li id="fn2"><p>These standard error are approximate when the mean of the characteristics is calculated from the sample of data used to the fit the model.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{martin2025,
  author = {Martin, Steve},
  title = {Hedonic Imputation with One Regression, Not Two},
  date = {2025-10-27},
  url = {https://marberts.github.io/blog/posts/2025/hedonics/},
  doi = {10.59350/2f0dq-zvs49},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-martin2025" class="csl-entry quarto-appendix-citeas">
Martin, Steve. 2025. <span>“Hedonic Imputation with One Regression, Not
Two.”</span> October 27, 2025. <a href="https://doi.org/10.59350/2f0dq-zvs49">https://doi.org/10.59350/2f0dq-zvs49</a>.
</div></div></section></div> ]]></description>
  <category>Index numbers</category>
  <category>Econometrics</category>
  <category>R</category>
  <guid>https://marberts.github.io/blog/posts/2025/hedonics/</guid>
  <pubDate>Mon, 27 Oct 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>What causes inflation?</title>
  <dc:creator>Steve Martin</dc:creator>
  <link>https://marberts.github.io/blog/posts/2025/inflation/</link>
  <description><![CDATA[ 





<p>What causes inflation in prices over time? Increases in the money supply, of course. Although there are many reasons for increasing prices over time, money supply is one of the few things that can do so and grow without bound. Case closed, right? Not quite.</p>
<p>In practice we can’t perfectly observe how prices change over time and instead we must measure inflation with an index number. Ignoring all the details that arise in practice, the goal is usually to construct a chained Laspeyres or Fisher index. There’s a nice disclaimer in the CPI manual about potential issues with these formulas when prices bounce or oscillate, rather than grow monotonically <span class="citation" data-cites="cpitheory">(IMF et al. 2025, 24)</span>. What I want to show here is that this can be a source of perpetual inflation. This means that, for example, increases and decreases in market concentration over time, which would result in fluctuating prices, can result a price index measuring inflation, even when prices don’t cumulatively change over time.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Let’s start with a simple two-commodity model where a representative consumer has Cobb-Douglas preferences. We’ll make a small class and mixin to make a Laspeyres and Fisher index given prices based on these preferences.</p>
<div id="9ebff752" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> IndexMixin:</span>
<span id="cb1-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> laspeyres(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, p1: np.ndarray, p0: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb1-7">        q0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.demand(p0)</span>
<span id="cb1-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q0) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q0)</span>
<span id="cb1-9"></span>
<span id="cb1-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> paasche(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, p1: np.ndarray, p0: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb1-11">        q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.demand(p1)</span>
<span id="cb1-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q1)</span>
<span id="cb1-13"></span>
<span id="cb1-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fisher(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, p1: np.ndarray, p0: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb1-15">        laspeyres <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.laspeyres(p1, p0)</span>
<span id="cb1-16">        paasche <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.paasche(p1, p0)</span>
<span id="cb1-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.sqrt(laspeyres <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> paasche)</span>
<span id="cb1-18"></span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CobbDouglas(IndexMixin):</span>
<span id="cb1-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, alpha: np.ndarray, m: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb1-22">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.asarray(alpha, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float64)</span>
<span id="cb1-23">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha)</span>
<span id="cb1-24">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(m)</span>
<span id="cb1-25"></span>
<span id="cb1-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, p: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb1-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(p) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha):</span>
<span id="cb1-28">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"must supply prices for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> products"</span>)</span>
<span id="cb1-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p</span></code></pre></div></div>
</div>
<p>We’ll also make a function to oscillate prices. The idea is to form a chain of index values that starts with both products having a price of <code>[1, 1]</code>, switches prices between <code>[1, 1.1]</code> and <code>[1.1, 1]</code> some number of times, and ends with prices back at <code>[1, 1]</code>. As a chained index is just the cumulative product of these index values, we can decompose the chained index into the product of the first and last change in price, and the product of the oscillations. What’s necessary to drive inflation is that the product of the oscillations is greater than 1.</p>
<p>We’ll also make a second function that does a more complex oscillation that we’ll use later.</p>
<div id="a0c139e5" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> bounce(index) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[np.float64]:</span>
<span id="cb2-2">    initial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-3">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>]</span>
<span id="cb2-4">    p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-5">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index(p1, initial) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> index(initial, p1)</span>
<span id="cb2-6">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index(p2, p1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> index(p1, p2)</span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> i, b</span>
<span id="cb2-8"></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> bounce2(index) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>[np.float64]:</span>
<span id="cb2-11">    initial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-12">    p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>]</span>
<span id="cb2-13">    p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-14">    p3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-15">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index(p1, initial) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> index(initial, p1)</span>
<span id="cb2-16">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> index(p2, p1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> index(p3, p2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> index(p1, p3)</span>
<span id="cb2-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> i, b</span></code></pre></div></div>
</div>
</section>
<section id="inflation-due-to-measurement" class="level2">
<h2 class="anchored" data-anchor-id="inflation-due-to-measurement">Inflation due to measurement</h2>
<p>Let’s start by generating some preferences and giving our representative consumer a fixed income, then simulating how the chained Laspeyres index evolves as prices bounce around.</p>
<div id="696c094c" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CobbDouglas([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bounce(u.laspeyres)</span>
<span id="cb3-4"></span>
<span id="cb3-5">oscillate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)]</span>
<span id="cb3-6"></span>
<span id="cb3-7">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb3-8">ax.plot(oscillate)</span>
<span id="cb3-9">plt.xticks(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-10">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/inflation/index_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we see that, despite prices starting and ending at the same level, the chained Laspeyres index shows that prices have increased over time. This happens because each oscillation registers an increase in prices (about 0.8%), and these compound to show that prices are increasing over time. Note that the culprit here is the well-known substitution bias in the Laspeyres index; if there was no substitution bias then the index would be transitive with Cobb-Douglas preferences and (correctly) show no change in prices over time. Instead, this happens with Leontief preferences.</p>
<div id="25f5a889" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Leontief(IndexMixin):</span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, m: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb4-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(m)</span>
<span id="cb4-4"></span>
<span id="cb4-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> demand(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, p: np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb4-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.repeat(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(p))</span>
<span id="cb4-7"></span>
<span id="cb4-8">bounce(Leontief(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>).laspeyres)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>(np.float64(1.0), np.float64(1.0))</code></pre>
</div>
</div>
<p>Both components of the chained index—the first and last change in price and the part due to oscillations—show no change in price.</p>
<p>We can get the same behavior from the Fisher index, albeit with a more complex form of oscillation. (Using the simple oscillation would show no change in prices over time because the Fisher index satisfies the time-reversal property.)</p>
<div id="6f17e714" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bounce2(u.fisher)</span>
<span id="cb6-2"></span>
<span id="cb6-3">oscillate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)]</span>
<span id="cb6-4"></span>
<span id="cb6-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb6-6">ax.plot(oscillate)</span>
<span id="cb6-7">plt.xticks(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb6-8">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/inflation/index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Each oscillation registers a 0.02% increase in prices. Note that this behavior from the Fisher index is sensitive to the parameters in the Cobb-Douglas utility function and it’s also possible to get that prices decreases over time.</p>
<div id="d51659d7" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CobbDouglas([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb7-2">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bounce2(u.fisher)</span>
<span id="cb7-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(res)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>(np.float64(1.0), np.float64(0.9998308882582081))</code></pre>
</div>
</div>
<p>Overall, this example shows that more than just money supply can drive our measurement of inflation, even if increasing money supply is the only true cause of inflation.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-cpitheory" class="csl-entry">
IMF, ILO, Eurostat, UNECE, OECD, and World Bank. 2025. <em>Consumer Price Index Manual: Theory</em>. International Monetary Fund. <a href="https://doi.org/10.5089/9781513559605.069">https://doi.org/10.5089/9781513559605.069</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{martin2025,
  author = {Martin, Steve},
  title = {What Causes Inflation?},
  date = {2025-10-22},
  url = {https://marberts.github.io/blog/posts/2025/inflation/},
  doi = {10.59350/nag8p-v2n95},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-martin2025" class="csl-entry quarto-appendix-citeas">
Martin, Steve. 2025. <span>“What Causes Inflation?”</span> October 22,
2025. <a href="https://doi.org/10.59350/nag8p-v2n95">https://doi.org/10.59350/nag8p-v2n95</a>.
</div></div></section></div> ]]></description>
  <category>Index numbers</category>
  <category>Python</category>
  <guid>https://marberts.github.io/blog/posts/2025/inflation/</guid>
  <pubDate>Wed, 22 Oct 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Decomposing diversity indexes</title>
  <dc:creator>Steve Martin</dc:creator>
  <link>https://marberts.github.io/blog/posts/2025/diversity/</link>
  <description><![CDATA[ 





<p>A diversity index is a way to measure the prevalence of different species in an ecosystem. Although these arise naturally in ecology, diversity indexes show up elsewhere as well. In economics, for example, we can think of diversity as related to the market concentration of firms (species) in an industry (ecosystem). What I want to show here is how we can use some of the machinery from the world of price and quantity indexes to decompose a diversity index into the contribution of each species towards overall diversity.</p>
<section id="what-is-diversity-anyway" class="level2">
<h2 class="anchored" data-anchor-id="what-is-diversity-anyway">What is diversity, anyway?</h2>
<p>Diversity is a tricky concept to formalize. Up until writing this post, I would have said it was just the number of species in an ecosystem. In his seminal paper, <span class="citation" data-cites="hill">Hill (1973)</span> considers a family diversity indexes that give a measure of the effective number of species in an ecosystem—that is, the number of species that would be present in an ecosystem if all species were equally prevalent. Mathemetically, if there are <img src="https://latex.codecogs.com/png.latex?n"> species and the <img src="https://latex.codecogs.com/png.latex?i">-th species appears with probability <img src="https://latex.codecogs.com/png.latex?p_%7Bi%7D">, then the diversity index of order <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AN_%7B%5Calpha%7D(p_%7B1%7D,%20%5Cldots,%20p_%7Bn%7D)%20=%20%5Cleft(%5Csum_%7Bi=1%7D%5E%7Bn%7Dp_%7Bi%7D%5E%7B%5Calpha%7D%5Cright)%5E%7B%5Cfrac%7B1%7D%7B1%20-%20%5Calpha%7D%7D.%0A"></p>
<p>Different values for <img src="https://latex.codecogs.com/png.latex?%5Calpha"> yield different indexes; for example, <img src="https://latex.codecogs.com/png.latex?N_%7B0%7D"> measures diversity by the total number of species <img src="https://latex.codecogs.com/png.latex?n">, also known as the richness of the ecosystem. As a function of <img src="https://latex.codecogs.com/png.latex?%5Calpha">, <img src="https://latex.codecogs.com/png.latex?N_%7B%5Calpha%7D"> is a continuously decreasing function that maps values in <img src="https://latex.codecogs.com/png.latex?%5B0,%20%5Cinfty)"> onto <img src="https://latex.codecogs.com/png.latex?%5Bn,%201%20/%20%5Cmax(p_%7B1%7D,%20%5Cldots,%20p_%7Bn%7D))">. We can see this with an example of an ecosystem with 10 species.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">diversity_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, alpha) {</span>
<span id="cb1-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb1-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>alpha)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha))</span>
<span id="cb1-4">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb1-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(p)))</span>
<span id="cb1-6">  }</span>
<span id="cb1-7">}</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54321</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_weights</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)))</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Abundance of species in an ecosystem"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/diversity/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">alphas <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb2-2">index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(alphas, \(a) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diversity_index</span>(p, a))</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(</span>
<span id="cb2-5">  alphas,</span>
<span id="cb2-6">  index,</span>
<span id="cb2-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb2-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"𝛼"</span>,</span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Index"</span>,</span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Diversity decreases with 𝛼"</span></span>
<span id="cb2-11">)</span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(p), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)</span></code></pre></div></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://marberts.github.io/blog/posts/2025/diversity/index_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With a bit of rearranging, we can see that <img src="https://latex.codecogs.com/png.latex?N_%5Calpha"> is the reciprocal of the generalized mean of <img src="https://latex.codecogs.com/png.latex?(p_%7B1%7D,%20%5Cldots,%20p_%7Bn%7D)"> with these same values as weights</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AN_%7B%5Calpha%7D(p_%7B1%7D,%20%5Cldots,%20p_%7Bn%7D)%20=%201%20/%20%5Cleft(%5Csum_%7Bi=1%7D%5E%7Bn%7D%20p_%7Bi%7D%5E%7B%5Calpha%20-%201%7D%20p_%7Bi%7D%5Cright)%5E%7B%5Cfrac%7B1%7D%7B%5Calpha%20-%201%7D%7D.%0A"></p>
<p>Formulating <img src="https://latex.codecogs.com/png.latex?N_%7B%5Calpha%7D"> as a generalized mean shows a clear link between diversity indexes and concentration indexes, as <img src="https://latex.codecogs.com/png.latex?N_%7B2%7D"> is the reciprocal of the well-known Simpson index (or Herfindahl–Hirschman index if you’re an economist). (It also shows a link with measures of entropy, as <img src="https://latex.codecogs.com/png.latex?%5Clog(N_%7B%5Calpha%7D)"> is a generalization of Shannon entropy.) What makes a diversity index different from a measure of concentration (or entropy) is that it expresses diversity in terms of the effective size of the ecosystem that would give rise to a particular concentration of species if species were all equally abundant. Intuitively, <img src="https://latex.codecogs.com/png.latex?1%20/%20p_%7Bi%7D"> gives the effective size of the ecosystem if all species were as prevalent as species <img src="https://latex.codecogs.com/png.latex?i">. Rather than considering a single species, <img src="https://latex.codecogs.com/png.latex?N_%7Ba%7D"> uses the average abundance across all species to arrive at a measure of diversity.</p>
</section>
<section id="decomposing-diversity" class="level2">
<h2 class="anchored" data-anchor-id="decomposing-diversity">Decomposing diversity</h2>
<p><span class="citation" data-cites="hill">Hill (1973)</span> notes that different choices for <img src="https://latex.codecogs.com/png.latex?%5Calpha"> imply different sensitivities to rare versus abundant species in an ecosystem. Setting <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200"> means that diversity depends only on the number of species, no matter how rare some may be, whereas when <img src="https://latex.codecogs.com/png.latex?%5Calpha%20%5Crightarrow%20%5Cinfty"> then only the most prevalent species influences diversity. We can go one step further by decomposing <img src="https://latex.codecogs.com/png.latex?N_%7B%5Calpha%7D"> so that it’s represented as an arithmetic mean of the effective size of each species <img src="https://latex.codecogs.com/png.latex?1%20/%20p_%7Bi%7D"> and we can see the contribution of each species towards total diversity. We’ll do this by borrowing some of the machinery from price and quantity indexes to derive weights <img src="https://latex.codecogs.com/png.latex?(w_%7B1%7D,%20%5Cldots,%20w_%7Bn%7D)"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AN_%7B%5Calpha%7D(p_%7B1%7D,%20%5Cldots,%20p_%7Bn%7D)%20=%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20w_%7Bi%7D%20/%20p_%7Bi%7D.%0A"></p>
<p>The core tool to do this comes from my <a href="https://marberts.github.io/gpindex"><code>{gpindex}</code></a> package.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">diversity_weights <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, alpha) {</span>
<span id="cb3-2">  gpindex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute_weights</span>(alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(x, x)</span>
<span id="cb3-3">}</span></code></pre></div></div>
</div>
<p>When <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200">, each species contributes the same amount to overall diversity.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diversity_weights</span>(p, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 1 1 1 1 1 1 1 1 1</code></pre>
</div>
</div>
<p>Increasing <img src="https://latex.codecogs.com/png.latex?%5Calpha"> to 2, the measure of diversity decreases and more weight is shifted towards more abundant species.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diversity_weights</span>(p, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.02204630 0.02298373 0.04003915 0.04733940 0.05467209 0.07962440
 [7] 0.10013170 0.14336078 0.48334916 1.48242257</code></pre>
</div>
</div>
<p>As alpha becomes larger, rare species get a small weight and contribute little towards overall diversity.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diversity_weights</span>(p, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 4.429620e-05 4.817851e-05 1.481826e-04 2.083463e-04 2.795183e-04
 [6] 6.049503e-04 9.729488e-04 2.068354e-03 3.261787e-02 9.630074e-01</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diversity_weights</span>(p, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.004974804 0.005190128 0.009163420 0.010897035 0.012658720 0.018811300
 [7] 0.024058228 0.035722328 0.167085953 1.608432485</code></pre>
</div>
</div>
<p>This gives a different way to view the prevalence of a species, not just by their abundance but by how their abundance contributes towards overall diversity in an ecosystem.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-hill" class="csl-entry">
Hill, Mark O. 1973. <span>“Diversity and Evenness: A Unifying Notation and Its Consequences.”</span> <em>Ecology</em> 54 (2): 427–32. <a href="https://doi.org/10.2307/1934352">https://doi.org/10.2307/1934352</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{martin2025,
  author = {Martin, Steve},
  title = {Decomposing Diversity Indexes},
  date = {2025-10-19},
  url = {https://marberts.github.io/blog/posts/2025/diversity/},
  doi = {10.59350/dfntc-yfd90},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-martin2025" class="csl-entry quarto-appendix-citeas">
Martin, Steve. 2025. <span>“Decomposing Diversity Indexes.”</span>
October 19, 2025. <a href="https://doi.org/10.59350/dfntc-yfd90">https://doi.org/10.59350/dfntc-yfd90</a>.
</div></div></section></div> ]]></description>
  <category>Index numbers</category>
  <category>R</category>
  <guid>https://marberts.github.io/blog/posts/2025/diversity/</guid>
  <pubDate>Sun, 19 Oct 2025 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
